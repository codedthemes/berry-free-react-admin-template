{"version":3,"sources":["../../src/commands/MigrationGenerateCommand.ts"],"names":[],"mappings":"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","file":"MigrationGenerateCommand.js","sourcesContent":["import { CommandUtils } from \"./CommandUtils\"\nimport { camelCase } from \"../util/StringUtils\"\nimport * as yargs from \"yargs\"\nimport chalk from \"chalk\"\nimport { format } from \"@sqltools/formatter/lib/sqlFormatter\"\nimport { PlatformTools } from \"../platform/PlatformTools\"\nimport { DataSource } from \"../data-source\"\nimport * as path from \"path\"\nimport process from \"process\"\n\n/**\n * Generates a new migration file with sql needs to be executed to update schema.\n */\nexport class MigrationGenerateCommand implements yargs.CommandModule {\n    command = \"migration:generate <path>\"\n    describe =\n        \"Generates a new migration file with sql needs to be executed to update schema.\"\n\n    builder(args: yargs.Argv) {\n        return args\n            .option(\"dataSource\", {\n                alias: \"d\",\n                type: \"string\",\n                describe:\n                    \"Path to the file where your DataSource instance is defined.\",\n                demandOption: true,\n            })\n            .option(\"p\", {\n                alias: \"pretty\",\n                type: \"boolean\",\n                default: false,\n                describe: \"Pretty-print generated SQL\",\n            })\n            .option(\"o\", {\n                alias: \"outputJs\",\n                type: \"boolean\",\n                default: false,\n                describe:\n                    \"Generate a migration file on Javascript instead of Typescript\",\n            })\n            .option(\"dr\", {\n                alias: \"dryrun\",\n                type: \"boolean\",\n                default: false,\n                describe:\n                    \"Prints out the contents of the migration instead of writing it to a file\",\n            })\n            .option(\"ch\", {\n                alias: \"check\",\n                type: \"boolean\",\n                default: false,\n                describe:\n                    \"Verifies that the current database is up to date and that no migrations are needed. Otherwise exits with code 1.\",\n            })\n            .option(\"t\", {\n                alias: \"timestamp\",\n                type: \"number\",\n                default: false,\n                describe: \"Custom timestamp for the migration name\",\n            })\n    }\n\n    async handler(args: yargs.Arguments) {\n        const timestamp = CommandUtils.getTimestamp(args.timestamp)\n        const extension = args.outputJs ? \".js\" : \".ts\"\n        const fullPath = (args.path as string).startsWith(\"/\")\n            ? (args.path as string)\n            : path.resolve(process.cwd(), args.path as string)\n        const filename = timestamp + \"-\" + path.basename(fullPath) + extension\n\n        let dataSource: DataSource | undefined = undefined\n        try {\n            dataSource = await CommandUtils.loadDataSource(\n                path.resolve(process.cwd(), args.dataSource as string),\n            )\n            dataSource.setOptions({\n                synchronize: false,\n                migrationsRun: false,\n                dropSchema: false,\n                logging: false,\n            })\n            await dataSource.initialize()\n\n            const upSqls: string[] = [],\n                downSqls: string[] = []\n\n            try {\n                const sqlInMemory = await dataSource.driver\n                    .createSchemaBuilder()\n                    .log()\n\n                if (args.pretty) {\n                    sqlInMemory.upQueries.forEach((upQuery) => {\n                        upQuery.query = MigrationGenerateCommand.prettifyQuery(\n                            upQuery.query,\n                        )\n                    })\n                    sqlInMemory.downQueries.forEach((downQuery) => {\n                        downQuery.query =\n                            MigrationGenerateCommand.prettifyQuery(\n                                downQuery.query,\n                            )\n                    })\n                }\n\n                sqlInMemory.upQueries.forEach((upQuery) => {\n                    upSqls.push(\n                        \"        await queryRunner.query(`\" +\n                            upQuery.query.replace(new RegExp(\"`\", \"g\"), \"\\\\`\") +\n                            \"`\" +\n                            MigrationGenerateCommand.queryParams(\n                                upQuery.parameters,\n                            ) +\n                            \");\",\n                    )\n                })\n                sqlInMemory.downQueries.forEach((downQuery) => {\n                    downSqls.push(\n                        \"        await queryRunner.query(`\" +\n                            downQuery.query.replace(\n                                new RegExp(\"`\", \"g\"),\n                                \"\\\\`\",\n                            ) +\n                            \"`\" +\n                            MigrationGenerateCommand.queryParams(\n                                downQuery.parameters,\n                            ) +\n                            \");\",\n                    )\n                })\n            } finally {\n                await dataSource.destroy()\n            }\n\n            if (!upSqls.length) {\n                if (args.check) {\n                    console.log(\n                        chalk.green(`No changes in database schema were found`),\n                    )\n                    process.exit(0)\n                } else {\n                    console.log(\n                        chalk.yellow(\n                            `No changes in database schema were found - cannot generate a migration. To create a new empty migration use \"typeorm migration:create\" command`,\n                        ),\n                    )\n                    process.exit(1)\n                }\n            } else if (!args.path) {\n                console.log(chalk.yellow(\"Please specify a migration path\"))\n                process.exit(1)\n            }\n\n            const fileContent = args.outputJs\n                ? MigrationGenerateCommand.getJavascriptTemplate(\n                      path.basename(fullPath),\n                      timestamp,\n                      upSqls,\n                      downSqls.reverse(),\n                  )\n                : MigrationGenerateCommand.getTemplate(\n                      path.basename(fullPath),\n                      timestamp,\n                      upSqls,\n                      downSqls.reverse(),\n                  )\n\n            if (args.check) {\n                console.log(\n                    chalk.yellow(\n                        `Unexpected changes in database schema were found in check mode:\\n\\n${chalk.white(\n                            fileContent,\n                        )}`,\n                    ),\n                )\n                process.exit(1)\n            }\n\n            if (args.dryrun) {\n                console.log(\n                    chalk.green(\n                        `Migration ${chalk.blue(\n                            fullPath + extension,\n                        )} has content:\\n\\n${chalk.white(fileContent)}`,\n                    ),\n                )\n            } else {\n                const migrationFileName =\n                    path.dirname(fullPath) + \"/\" + filename\n                await CommandUtils.createFile(migrationFileName, fileContent)\n\n                console.log(\n                    chalk.green(\n                        `Migration ${chalk.blue(\n                            migrationFileName,\n                        )} has been generated successfully.`,\n                    ),\n                )\n                process.exit(0)\n            }\n        } catch (err) {\n            PlatformTools.logCmdErr(\"Error during migration generation:\", err)\n            process.exit(1)\n        }\n    }\n\n    // -------------------------------------------------------------------------\n    // Protected Static Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Formats query parameters for migration queries if parameters actually exist\n     */\n    protected static queryParams(parameters: any[] | undefined): string {\n        if (!parameters || !parameters.length) {\n            return \"\"\n        }\n\n        return `, ${JSON.stringify(parameters)}`\n    }\n\n    /**\n     * Gets contents of the migration file.\n     */\n    protected static getTemplate(\n        name: string,\n        timestamp: number,\n        upSqls: string[],\n        downSqls: string[],\n    ): string {\n        const migrationName = `${camelCase(name, true)}${timestamp}`\n\n        return `import { MigrationInterface, QueryRunner } from \"typeorm\";\n\nexport class ${migrationName} implements MigrationInterface {\n    name = '${migrationName}'\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n${upSqls.join(`\n`)}\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n${downSqls.join(`\n`)}\n    }\n\n}\n`\n    }\n\n    /**\n     * Gets contents of the migration file in Javascript.\n     */\n    protected static getJavascriptTemplate(\n        name: string,\n        timestamp: number,\n        upSqls: string[],\n        downSqls: string[],\n    ): string {\n        const migrationName = `${camelCase(name, true)}${timestamp}`\n\n        return `const { MigrationInterface, QueryRunner } = require(\"typeorm\");\n\nmodule.exports = class ${migrationName} {\n    name = '${migrationName}'\n\n    async up(queryRunner) {\n${upSqls.join(`\n`)}\n    }\n\n    async down(queryRunner) {\n${downSqls.join(`\n`)}\n    }\n}\n`\n    }\n\n    /**\n     *\n     */\n    protected static prettifyQuery(query: string) {\n        const formattedQuery = format(query, { indent: \"    \" })\n        return (\n            \"\\n\" + formattedQuery.replace(/^/gm, \"            \") + \"\\n        \"\n        )\n    }\n}\n"],"sourceRoot":".."}